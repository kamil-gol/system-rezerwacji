// Prisma Schema for Gościniec Rodzinny Reservation System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum ReservationStatus {
  PENDING      // Oczekująca
  CONFIRMED    // Potwierdzona
  CANCELLED    // Anulowana
  COMPLETED    // Zakończona
  IN_PROGRESS  // W trakcie
}

enum PricingType {
  PER_PERSON   // Cena za osobę
  TOTAL        // Cena całościowa
}

enum DepositStatus {
  NOT_REQUIRED
  PENDING
  PAID
  OVERDUE
}

enum EventType {
  WEDDING          // Wesele
  BIRTHDAY         // Urodziny
  ANNIVERSARY      // Rocznica
  BUSINESS_MEETING // Spotkanie biznesowe
  PARTY            // Przyjęcie okolicznościowe
  CHRISTMAS        // Wigilia firmowa
  BAPTISM          // Chrzciny
  COMMUNION        // Komunie
}

enum ChangeType {
  CREATED
  UPDATED
  CANCELLED
  STATUS_CHANGED
  DEPOSIT_PAID
}

// ============================================
// MODELS
// ============================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hashed, min 12 chars
  firstName String
  lastName  String
  role      Role     @default(EMPLOYEE)
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  reservations      Reservation[]
  reservationChanges ReservationHistory[]
  createdCustomers  Customer[]
  
  @@index([email])
  @@map("users")
}

model Room {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  maxCapacity Int
  pricePerPerson Decimal @db.Decimal(10, 2)
  totalPrice     Decimal @db.Decimal(10, 2)
  isActive    Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  reservations Reservation[]
  
  @@index([name])
  @@map("rooms")
}

model Customer {
  id          String  @id @default(cuid())
  firstName   String
  lastName    String
  email       String?
  phone       String
  company     String?
  nip         String?
  address     String?
  city        String?
  postalCode  String?
  notes       String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  
  // Relations
  createdByUser User         @relation(fields: [createdBy], references: [id])
  reservations  Reservation[]
  
  @@index([phone])
  @@index([email])
  @@map("customers")
}

model Reservation {
  id              String            @id @default(cuid())
  reservationNumber String          @unique // Auto-generated: RES-YYYYMMDD-XXXX
  
  // Customer & Room
  customerId      String
  roomId          String
  
  // Event Details
  eventType       EventType
  eventDate       DateTime
  startTime       String            // HH:mm
  durationHours   Int               @default(6)
  numberOfGuests  Int
  
  // Pricing
  pricingType     PricingType       @default(PER_PERSON)
  pricePerPerson  Decimal?          @db.Decimal(10, 2)
  totalPrice      Decimal           @db.Decimal(10, 2)
  finalAmount     Decimal           @db.Decimal(10, 2) // After calculations
  
  // Deposit
  depositRequired Boolean           @default(false)
  depositAmount   Decimal?          @db.Decimal(10, 2)
  depositDueDate  DateTime?
  depositStatus   DepositStatus     @default(NOT_REQUIRED)
  depositPaidAt   DateTime?
  
  // Status
  status          ReservationStatus @default(PENDING)
  
  // Additional Info
  notes           String?
  specialRequests String?
  autoGeneratedNotes String?        // For extra hours
  
  // Cancellation
  cancellationReason String?
  cancelledAt        DateTime?
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  
  // Relations
  customer        Customer             @relation(fields: [customerId], references: [id])
  room            Room                 @relation(fields: [roomId], references: [id])
  createdByUser   User                 @relation(fields: [createdBy], references: [id])
  attachments     Attachment[]
  history         ReservationHistory[]
  emails          EmailLog[]
  
  @@index([customerId])
  @@index([roomId])
  @@index([eventDate])
  @@index([status])
  @@index([reservationNumber])
  @@map("reservations")
}

model ReservationHistory {
  id            String     @id @default(cuid())
  reservationId String
  
  changeType    ChangeType
  changedBy     String
  reason        String?    // Required for UPDATED and CANCELLED
  
  // Snapshot of changed fields
  previousValue Json?
  newValue      Json?
  
  createdAt DateTime @default(now())
  
  // Relations
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [changedBy], references: [id])
  
  @@index([reservationId])
  @@index([createdAt])
  @@map("reservation_history")
}

model Attachment {
  id            String   @id @default(cuid())
  reservationId String
  
  fileName      String
  originalName  String
  mimeType      String
  size          Int      // in bytes
  path          String
  
  uploadedAt DateTime @default(now())
  
  // Relations
  reservation Reservation @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  
  @@index([reservationId])
  @@map("attachments")
}

model EmailLog {
  id            String   @id @default(cuid())
  reservationId String?
  
  to            String
  subject       String
  body          String
  attachments   Json?    // Array of file names
  
  status        String   // sent, failed
  error         String?
  
  sentAt        DateTime @default(now())
  
  // Relations
  reservation Reservation? @relation(fields: [reservationId], references: [id])
  
  @@index([reservationId])
  @@index([sentAt])
  @@map("email_logs")
}

model SystemLog {
  id        String   @id @default(cuid())
  
  level     String   // info, warn, error
  message   String
  context   Json?
  
  createdAt DateTime @default(now())
  
  @@index([level])
  @@index([createdAt])
  @@map("system_logs")
}

model Backup {
  id        String   @id @default(cuid())
  
  fileName  String
  size      Int
  path      String
  
  createdAt DateTime @default(now())
  
  @@index([createdAt])
  @@map("backups")
}
